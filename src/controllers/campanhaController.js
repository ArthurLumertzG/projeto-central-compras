const CampanhasService = require("../services/campanhaService");
const FornecedoresModel = require("../models/fornecedoresModel");
const AppError = require("../errors/AppError");

class CampanhasController {
  constructor() {
    this.campanhasService = new CampanhasService();
    this.fornecedoresModel = new FornecedoresModel();
  }

  async getFornecedorIdByUsuarioId(usuario_id) {
    const fornecedor = await this.fornecedoresModel.selectByUsuarioId(usuario_id);
    if (!fornecedor[0]) {
      throw new AppError("Fornecedor não encontrado para este usuário", 404);
    }
    return fornecedor[0].id;
  }

  async getAll(req, res) {
    const fornecedor_id = await this.getFornecedorIdByUsuarioId(req.user.id);
    const response = await this.campanhasService.getByFornecedor(fornecedor_id);
    res.status(200).json(response);
  }

  async getById(req, res) {
    const { id } = req.params;
    const fornecedor_id = await this.getFornecedorIdByUsuarioId(req.user.id);
    const response = await this.campanhasService.getById(id, fornecedor_id);
    res.status(200).json(response);
  }

  async getByStatus(req, res) {
    const { status } = req.params;
    const response = await this.campanhasService.getByStatus(status);
    res.status(200).json(response);
  }

  async create(req, res) {
    const fornecedor_id = await this.getFornecedorIdByUsuarioId(req.user.id);
    const response = await this.campanhasService.create(req.body, fornecedor_id);
    res.status(201).json(response);
  }

  async update(req, res) {
    const { id } = req.params;
    const fornecedor_id = await this.getFornecedorIdByUsuarioId(req.user.id);
    const response = await this.campanhasService.update(id, req.body, fornecedor_id);
    res.status(200).json(response);
  }

  async delete(req, res) {
    const { id } = req.params;
    const fornecedor_id = await this.getFornecedorIdByUsuarioId(req.user.id);
    const response = await this.campanhasService.delete(id, fornecedor_id);
    res.status(200).json(response);
  }
}

module.exports = new CampanhasController();
